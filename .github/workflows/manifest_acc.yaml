name: Manifest acceptance tests

on:
  push:
    branches:
      - main
      - v3-major-release
    paths:
      - "manifest/**/*.go"
      - "manifest/**/go.mod"
  pull_request:
    branches:
      - main
      - v3-major-release
    paths:
      - "manifest/**/*.go"
      - "manifest/**/go.mod"
  workflow_dispatch:

env:
  KUBECONFIG: ${{ github.workspace }}/.kube/config

jobs:
  acceptance_tests:
    runs-on: ubuntu-latest
    strategy:
      # Don't cancel all in-progress and queued jobs in the matrix if any job in the matrix fails.
      # That will be helpful to catch any issues related to a particular Kubernetes version.
      fail-fast: false
      matrix:
        kubernetes_version:
          # kind images: https://github.com/kubernetes-sigs/kind/releases
          - v1.30.0@sha256:047357ac0cfea04663786a612ba1eaba9702bef25227a794b52890dd8bcd692e
          - v1.29.2@sha256:51a1434a5397193442f0be2a297b488b6c919ce8a3931be0ce822606ea5ca245
          - v1.28.7@sha256:9bc6c451a289cf96ad0bbaf33d416901de6fd632415b076ab05f5fa7e4f65c58
          - v1.27.11@sha256:681253009e68069b8e01aad36a1e0fa8cf18bb0ab3e5c4069b2e65cafdd70843
          - v1.26.14@sha256:5d648992dda1fdf1f613e927146ba965f4c6e3c3bda1f2f1b99a45b2be7b0195
        include:
          # This version will only run on the 'v3-major-release' branch
          - kubernetes_version: v1.31.2@sha256:33034c0a75dd82b2f2f22bdf0a30ea2a42b2c3547a6d56c52c7ea9c1b5fb89b9
            branches: ['v3-major-release']

        terraform_version:
          - 1.9.8
          - 1.8.5
          - 1.6.6
          - 1.5.7
          - 1.4.7
          - 1.3.10
          - 1.2.9
          - 1.1.9
          - 1.0.11

    steps:
      - uses: actions/checkout@0ad4b8fadaa221de15dcec353f45205ec38ea70b # v4.1.4
      - name: Set up Go
        uses: actions/setup-go@0c52d547c9bc32b1aa3301fd7a9cb496313a4491 # v5.0.0
        with:
          go-version-file: 'go.mod'
      - name: Setup kind
        uses: helm/kind-action@0025e74a8c7512023d06dc019c617aa3cf561fde # v1.10.0
        with:
          version: v0.21.0
          node_image: kindest/node:${{ matrix.kubernetes_version }}
          # By default, this action creates a cluster with the name 'chart-testing'
          cluster_name: manifest
      - name: Build annotations webhook
        run: |
          docker build --rm -t tf-k8s-acc-webhook ./manifest/test/acceptance/testdata/ComputedFields/webhook/
          kind load docker-image tf-k8s-acc-webhook --name=manifest
      - name: Run tests
        env:
          KUBE_CONFIG_PATH: ${{ env.KUBECONFIG }}
          TF_ACC_TERRAFORM_VERSION: ${{ matrix.terraform_version }}
        run: |
          go test -count=1 -tags acceptance -v ./manifest/test/acceptance/... -timeout 120m
